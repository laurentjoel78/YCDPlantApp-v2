const nodemailer = require('nodemailer');

let instance = null;

class EmailService {
  constructor() {
    // Create a test account for development
    if (process.env.NODE_ENV !== 'production') {
      this.createTestAccount();
    } else {
      this.initializeTransporter();
    }
  }

  async createTestAccount() {
    try {
      const testAccount = await nodemailer.createTestAccount();
      this.transporter = nodemailer.createTransport({
        host: 'smtp.ethereal.email',
        port: 587,
        secure: false,
        auth: {
          user: testAccount.user,
          pass: testAccount.pass,
        },
      });
      console.log('Test email account created:', testAccount.user);
    } catch (error) {
      console.error('Error creating test email account:', error);
      this.initializeTransporter(); // Fallback to configured transport
    }
  }

  initializeTransporter() {
    this.transporter = nodemailer.createTransport({
      host: process.env.EMAIL_HOST,
      port: process.env.EMAIL_PORT,
      secure: process.env.EMAIL_SECURE === 'true',
      auth: {
        user: process.env.EMAIL_USER,
        pass: process.env.EMAIL_PASSWORD,
      },
    });
  }

  async sendEmail(to, subject, html) {
    try {
      const info = await this.transporter.sendMail({
        from: `"YCD Farmer Guide" <${process.env.EMAIL_FROM}>`,
        to,
        subject,
        html,
      });
      console.log('Email sent: %s', info.messageId);
      return info;
    } catch (error) {
      console.error('Error sending email:', error);
      throw error;
    }
  }

  async sendVerificationEmail(user, verificationToken) {
    const verificationUrl = `${process.env.FRONTEND_URL}/verify-email?token=${verificationToken}`;

    const html = `
      <h1>Welcome to YCD Farmer Guide!</h1>
      <p>Hello ${user.first_name},</p>
      <p>Thank you for registering with YCD Farmer Guide. Please click the button below to verify your email address:</p>
      <a href="${verificationUrl}" style="background-color: #4CAF50; color: white; padding: 14px 20px; text-decoration: none; border-radius: 4px;">
        Verify Email
      </a>
      <p>If you didn't create this account, please ignore this email.</p>
      <p>This link will expire in 24 hours.</p>
    `;

    return this.sendEmail(user.email, 'Verify Your Email - YCD Farmer Guide', html);
  }

  async sendPasswordResetEmail(user, resetToken) {
    const resetUrl = `${process.env.FRONTEND_URL}/reset-password?token=${resetToken}`;

    const html = `
      <h1>Password Reset Request</h1>
      <p>Hello ${user.first_name},</p>
      <p>You recently requested to reset your password. Click the button below to reset it:</p>
      <a href="${resetUrl}" style="background-color: #4CAF50; color: white; padding: 14px 20px; text-decoration: none; border-radius: 4px;">
        Reset Password
      </a>
      <p>If you didn't request this, please ignore this email and your password will remain unchanged.</p>
      <p>This link will expire in 1 hour.</p>
    `;

    return this.sendEmail(user.email, 'Reset Your Password - YCD Farmer Guide', html);
  }

  async sendAccountApprovalEmail(user, status) {
    let subject, content;

    if (status === 'approved') {
      subject = 'Account Approved - YCD Farmer Guide';
      content = `
        <h1>Account Approved!</h1>
        <p>Hello ${user.first_name},</p>
        <p>Your YCD Farmer Guide account has been approved. You can now login and access all features.</p>
        <a href="${process.env.FRONTEND_URL}/login" style="background-color: #4CAF50; color: white; padding: 14px 20px; text-decoration: none; border-radius: 4px;">
          Login Now
        </a>
      `;
    } else if (status === 'rejected') {
      subject = 'Account Application Status - YCD Farmer Guide';
      content = `
        <h1>Account Application Update</h1>
        <p>Hello ${user.first_name},</p>
        <p>We regret to inform you that your account application has been declined at this time.</p>
        <p>If you believe this is an error or would like to submit additional information, please contact our support team.</p>
      `;
    }

    return this.sendEmail(user.email, subject, content);
  }

  async sendWelcomeEmail(user) {
    const loginUrl = `${process.env.FRONTEND_URL}/login`;

    const html = `
      <h1>Welcome to YCD Farmer Guide!</h1>
      <p>Hello ${user.first_name},</p>
      <p>Thank you for joining YCD Farmer Guide. We're excited to have you on board!</p>
      ${user.role === 'farmer' ? `
        <p>Your account is currently pending approval. We'll notify you once your account has been reviewed.</p>
      ` : `
        <p>You can now login to access all features:</p>
        <a href="${loginUrl}" style="background-color: #4CAF50; color: white; padding: 14px 20px; text-decoration: none; border-radius: 4px;">
          Login Now
        </a>
      `}
      <p>If you have any questions, please don't hesitate to contact our support team.</p>
    `;

    return this.sendEmail(user.email, 'Welcome to YCD Farmer Guide', html);
        <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: center;">
          ${item.quantity}
        </td>
        <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;">
          ${parseFloat(item.price_at_add).toLocaleString()} XAF
        </td>
        <td style="padding: 10px; border-bottom: 1px solid #eee; text-align: right;">
          ${(parseFloat(item.price_at_add) * item.quantity).toLocaleString()} XAF
        </td>
      </tr>
    `).join('');

    const html = `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <h1 style="color: #4CAF50;">Order Confirmation</h1>
        <p>Hello ${user.first_name || 'Customer'},</p>
        <p>Thank you for your order! Your order has been confirmed.</p>
        
        <h2>Order Details</h2>
        <p><strong>Order ID:</strong> ${order.id.substring(0, 8).toUpperCase()}</p>
        <p><strong>Status:</strong> ${order.status}</p>
        <p><strong>Payment Status:</strong> ${order.payment_status}</p>
        
        <h3>Items:</h3>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #f5f5f5;">
              <th style="padding: 10px; text-align: left;">Product</th>
              <th style="padding: 10px; text-align: center;">Qty</th>
              <th style="padding: 10px; text-align: right;">Price</th>
              <th style="padding: 10px; text-align: right;">Total</th>
            </tr>
          </thead>
          <tbody>
            ${itemsList}
          </tbody>
          <tfoot>
            <tr>
              <td colspan="3" style="padding: 10px; text-align: right;"><strong>Subtotal:</strong></td>
              <td style="padding: 10px; text-align: right;">${order.metadata?.subtotal?.toLocaleString() || 0} XAF</td>
            </tr>
            <tr>
              <td colspan="3" style="padding: 10px; text-align: right;"><strong>Delivery:</strong></td>
              <td style="padding: 10px; text-align: right;">${order.metadata?.deliveryFee?.toLocaleString() || 2000} XAF</td>
            </tr>
            <tr style="font-size: 18px; font-weight: bold;">
              <td colspan="3" style="padding: 10px; text-align: right;">Total:</td>
              <td style="padding: 10px; text-align: right; color: #4CAF50;">${parseFloat(order.total_amount).toLocaleString()} XAF</td>
            </tr>
          </tfoot>
        </table>
        
        <h3>Delivery Address:</h3>
        <p>
          ${deliveryAddress.address || order.shipping_address || 'N/A'}<br>
          ${deliveryAddress.city || ''} ${deliveryAddress.region || ''}
        </p>
        
        <p style="margin-top: 30px; color: #666;">
          Expected delivery: 2-3 business days<br>
          You will receive updates on your order status.
        </p>
        
        <p>Thank you for shopping with YCD Farmer Guide!</p>
      </div>
    `;

    return this.sendEmail(user.email, `Order Confirmation - #${order.id.substring(0, 8)}`, html);
  }
}

const getEmailService = () => {
  if (!instance) {
    instance = new EmailService();
  }
  return instance;
};

module.exports = getEmailService();